/*
 * 아두이노 - ArUco 기반 PID 제어 정밀 주차
 * PID Library: https://github.com/br3ttb/Arduino-PID-Library
 */

#include <ArduinoJson.h>
#include <PID_v1.h>

// 모터 핀
#define MOTOR_LEFT_FWD  5
#define MOTOR_LEFT_BWD  6
#define MOTOR_RIGHT_FWD 9
#define MOTOR_RIGHT_BWD 10

// 변수
int markerID = -1;
int markerX = 0;
int markerY = 0;

#define CENTER_X 320
#define CENTER_Y 240

// PID 변수
double setpointX = CENTER_X;
double inputX = CENTER_X;
double outputX = 0;

double setpointY = CENTER_Y;
double inputY = CENTER_Y;
double outputY = 0;

// PID 튜닝 파라미터
double Kp_X = 2.0, Ki_X = 0.5, Kd_X = 1.0;
double Kp_Y = 1.5, Ki_Y = 0.3, Kd_Y = 0.8;

// PID 컨트롤러
PID pidX(&inputX, &outputX, &setpointX, Kp_X, Ki_X, Kd_X, DIRECT);
PID pidY(&inputY, &outputY, &setpointY, Kp_Y, Ki_Y, Kd_Y, DIRECT);

#define TOLERANCE_X 20
#define TOLERANCE_Y 20

void setup() {
  Serial.begin(9600);
  
  pinMode(MOTOR_LEFT_FWD, OUTPUT);
  pinMode(MOTOR_LEFT_BWD, OUTPUT);
  pinMode(MOTOR_RIGHT_FWD, OUTPUT);
  pinMode(MOTOR_RIGHT_BWD, OUTPUT);
  
  pidX.SetMode(AUTOMATIC);
  pidX.SetOutputLimits(-255, 255);
  pidX.SetSampleTime(50);
  
  pidY.SetMode(AUTOMATIC);
  pidY.SetOutputLimits(-255, 255);
  pidY.SetSampleTime(50);
  
  Serial.println("PID Ready");
}

void loop() {
  if (Serial.available() > 0) {
    String jsonString = Serial.readStringUntil('\n');
    
    StaticJsonDocument<200> doc;
    DeserializationError error = deserializeJson(doc, jsonString);
    
    if (!error) {
      markerID = doc["id"];
      markerX = doc["x"];
      markerY = doc["y"];
      
      controlByMarkerID(markerID, markerX, markerY);
    }
  }
}

void controlByMarkerID(int id, int x, int y) {
  if (id >= 0 && id <= 99) {
    followCeilingMarker(x);
  } else if (id >= 100 && id <= 149) {
    turnAtWall(id);
  } else if (id >= 150 && id <= 199) {
    if (id % 2 == 1) {
      pidParkingControl(x, y);
    } else {
      moveForward(150);
    }
  } else if (id == 200) {
    stopMotors();
  }
}

void pidParkingControl(int x, int y) {
  inputX = x;
  inputY = y;
  
  int errorX = abs(x - CENTER_X);
  int errorY = abs(y - CENTER_Y);
  
  if (errorX < TOLERANCE_X && errorY < TOLERANCE_Y) {
    stopMotors();
    Serial.println("PARKING ALIGNED!");
    return;
  }
  
  pidX.Compute();
  pidY.Compute();
  
  applyPIDToMotors(outputX, outputY);
  
  Serial.print("PID X:");
  Serial.print(outputX);
  Serial.print(" Y:");
  Serial.print(outputY);
  Serial.print(" Err X:");
  Serial.print(errorX);
  Serial.print(" Y:");
  Serial.println(errorY);
}

void applyPIDToMotors(double pidX, double pidY) {
  int baseSpeed = 80;
  
  // Y축 우선 (전후)
  if (abs(pidY) > 30) {
    if (pidY > 0) {
      int speed = constrain(abs(pidY), 60, 150);
      analogWrite(MOTOR_LEFT_FWD, speed);
      analogWrite(MOTOR_RIGHT_FWD, speed);
      analogWrite(MOTOR_LEFT_BWD, 0);
      analogWrite(MOTOR_RIGHT_BWD, 0);
    } else {
      int speed = constrain(abs(pidY), 60, 150);
      analogWrite(MOTOR_LEFT_FWD, 0);
      analogWrite(MOTOR_RIGHT_FWD, 0);
      analogWrite(MOTOR_LEFT_BWD, speed);
      analogWrite(MOTOR_RIGHT_BWD, speed);
    }
    return;
  }
  
  // X축 (좌우)
  if (abs(pidX) > 20) {
    if (pidX > 0) {
      int speed = constrain(abs(pidX), 60, 120);
      analogWrite(MOTOR_LEFT_FWD, speed);
      analogWrite(MOTOR_RIGHT_FWD, 0);
      analogWrite(MOTOR_LEFT_BWD, 0);
      analogWrite(MOTOR_RIGHT_BWD, speed);
    } else {
      int speed = constrain(abs(pidX), 60, 120);
      analogWrite(MOTOR_LEFT_FWD, 0);
      analogWrite(MOTOR_RIGHT_FWD, speed);
      analogWrite(MOTOR_LEFT_BWD, speed);
      analogWrite(MOTOR_RIGHT_BWD, 0);
    }
    return;
  }
  
  // 미세 조정
  int leftSpeed = baseSpeed - (int)pidX;
  int rightSpeed = baseSpeed + (int)pidX;
  
  leftSpeed = constrain(leftSpeed, -120, 120);
  rightSpeed = constrain(rightSpeed, -120, 120);
  
  if (leftSpeed >= 0) {
    analogWrite(MOTOR_LEFT_FWD, leftSpeed);
    analogWrite(MOTOR_LEFT_BWD, 0);
  } else {
    analogWrite(MOTOR_LEFT_FWD, 0);
    analogWrite(MOTOR_LEFT_BWD, abs(leftSpeed));
  }
  
  if (rightSpeed >= 0) {
    analogWrite(MOTOR_RIGHT_FWD, rightSpeed);
    analogWrite(MOTOR_RIGHT_BWD, 0);
  } else {
    analogWrite(MOTOR_RIGHT_FWD, 0);
    analogWrite(MOTOR_RIGHT_BWD, abs(rightSpeed));
  }
}

void followCeilingMarker(int x) {
  int baseSpeed = 150;
  int errorX = x - CENTER_X;
  int correction = errorX / 3;
  
  int leftSpeed = baseSpeed + correction;
  int rightSpeed = baseSpeed - correction;
  
  leftSpeed = constrain(leftSpeed, 0, 255);
  rightSpeed = constrain(rightSpeed, 0, 255);
  
  analogWrite(MOTOR_LEFT_FWD, leftSpeed);
  analogWrite(MOTOR_RIGHT_FWD, rightSpeed);
  analogWrite(MOTOR_LEFT_BWD, 0);
  analogWrite(MOTOR_RIGHT_BWD, 0);
}

void turnAtWall(int wallID) {
  if (wallID >= 100 && wallID < 125) {
    turnLeft(500);
  } else {
    turnRight(500);
  }
}

void moveForward(int duration) {
  analogWrite(MOTOR_LEFT_FWD, 150);
  analogWrite(MOTOR_RIGHT_FWD, 150);
  analogWrite(MOTOR_LEFT_BWD, 0);
  analogWrite(MOTOR_RIGHT_BWD, 0);
  delay(duration);
}

void turnLeft(int duration) {
  analogWrite(MOTOR_LEFT_FWD, 0);
  analogWrite(MOTOR_RIGHT_FWD, 150);
  analogWrite(MOTOR_LEFT_BWD, 150);
  analogWrite(MOTOR_RIGHT_BWD, 0);
  delay(duration);
  stopMotors();
}

void turnRight(int duration) {
  analogWrite(MOTOR_LEFT_FWD, 150);
  analogWrite(MOTOR_RIGHT_FWD, 0);
  analogWrite(MOTOR_LEFT_BWD, 0);
  analogWrite(MOTOR_RIGHT_BWD, 150);
  delay(duration);
  stopMotors();
}

void stopMotors() {
  analogWrite(MOTOR_LEFT_FWD, 0);
  analogWrite(MOTOR_RIGHT_FWD, 0);
  analogWrite(MOTOR_LEFT_BWD, 0);
  analogWrite(MOTOR_RIGHT_BWD, 0);
}
