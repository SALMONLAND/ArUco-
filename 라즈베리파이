#!/usr/bin/env python3
"""
라즈베리파이 - ArUco 마커 감지 및 시리얼 전송
"""

import cv2
import numpy as np
from picamera2 import Picamera2
import serial
import time
import json

# 시리얼 포트 설정
ser = serial.Serial('/dev/ttyACM0', 9600, timeout=1)
time.sleep(2)

# ArUco 설정
aruco_dict = cv2.aruco.getPredefinedDictionary(cv2.aruco.DICT_6X6_250)
aruco_params = cv2.aruco.DetectorParameters()
detector = cv2.aruco.ArucoDetector(aruco_dict, aruco_params)

# 카메라 초기화
picam2 = Picamera2()
config = picam2.create_preview_configuration(main={"size": (640, 480)})
picam2.configure(config)
picam2.start()
time.sleep(2)

print("ArUco 감지 시작...")

try:
    while True:
        # 프레임 캡처
        frame = picam2.capture_array()
        gray = cv2.cvtColor(frame, cv2.COLOR_RGB2GRAY)
        
        # ArUco 마커 감지
        corners, ids, _ = detector.detectMarkers(gray)
        
        if ids is not None:
            for i, marker_id in enumerate(ids.flatten()):
                # 마커 중심 위치 계산
                corner = corners[i][0]
                center_x = int(corner[:, 0].mean())
                center_y = int(corner[:, 1].mean())
                
                # 데이터 생성
                data = {
                    'id': int(marker_id),
                    'x': center_x,
                    'y': center_y
                }
                
                # JSON 형식으로 시리얼 전송
                json_data = json.dumps(data) + '\n'
                ser.write(json_data.encode())
                
                print(f"전송: ID={marker_id}, X={center_x}, Y={center_y}")
        
        time.sleep(0.1)

except KeyboardInterrupt:
    print("\n종료")
    picam2.stop()
    ser.close()
